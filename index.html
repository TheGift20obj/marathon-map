<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Cesium Marathon Globe</title>

<script src="https://unpkg.com/cesium@1.111.0/Build/Cesium/Cesium.js"></script>
<link href="https://unpkg.com/cesium@1.111.0/Build/Cesium/Widgets/widgets.css" rel="stylesheet">

<style>
html, body, #cesiumContainer {
    width:100%;
    height:100%;
    margin:0;
    padding:0;
    overflow:hidden;
    background:#000814;
}

#cesiumContainer { position:relative; }

/* ================= POPUP ================= */

#uiLabel {
    position: absolute;
    top: 70%;
    left: 50%;
    transform: translate(-50%, 100%);
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;

    font-size: 1.4rem;
    padding: 22px;
    width: clamp(280px, 40vw, 520px);

    background: linear-gradient(135deg, #6fb1fc, #4364f7);
    color: #fff;

    border-radius: 22px;
    border: 2px solid rgba(255,255,255,0.25);
    box-shadow: 0 20px 50px rgba(0,0,0,0.45);

    backdrop-filter: blur(6px);

    opacity: 0;
    pointer-events: none;

    transition:
        transform 0.55s cubic-bezier(0.68, -0.55, 0.27, 1.55),
        opacity 0.4s ease;

    z-index: 50;
}

#uiLabel.show {
    transform: translate(-50%, 0);
    opacity: 1;
    pointer-events: auto;
}

#uiLabel h3 {
    margin:0 0 10px 0;
    font-size: 2rem;
    font-weight: 700;
    letter-spacing: 0.5px;
}

#uiLabel ul {
    padding: 0;
    margin: 8px 0 0 0;
    list-style: none;
}

#uiLabel ul li {
    margin: 6px 0;
    font-weight: 500;
    opacity: 0.95;
}

/* CLOSE BUTTON */

#closeBtn {
    position: absolute;
    top: 10px;
    right: 14px;
    cursor: pointer;
    font-size: 1.4rem;
    font-weight: 700;
    transition: transform 0.2s ease, opacity 0.2s ease;
}

#closeBtn:hover {
    transform: scale(1.15);
    opacity: 0.8;
}

/* ================= LOADING SCREEN ================= */

#loadingScreen {
    position: fixed;
    inset: 0;
    background: linear-gradient(135deg,#6fb1fc,#4364f7);
    color: white;

    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;

    font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;

    z-index: 1000;
    opacity: 1;
    transition: opacity 1s ease;
}

#loadingScreen.hide {
    opacity: 0;
    pointer-events: none;
}

#loaderContent {
    text-align: center;
    padding: 20px;
}

/* SPINNER */

.spinner {
    width: 64px;
    height: 64px;
    border: 6px solid rgba(255,255,255,0.25);
    border-top: 6px solid #fff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 22px;
}

@keyframes spin {
    from {transform: rotate(0deg);}
    to {transform: rotate(360deg);}
}

#loadingText {
    font-size: 1.6rem;
    font-weight: 600;
    letter-spacing: 0.5px;
    transition: opacity 0.6s ease;
}

/* ================= RESPONSIVE ================= */

/* MOBILE */
@media (max-width: 600px) {

    #uiLabel {
        top: 72%;
        width: 88vw;
        padding: 18px;
        font-size: 1.1rem;
        border-radius: 18px;
    }

    #uiLabel h3 {
        font-size: 1.5rem;
    }

    #uiLabel ul li {
        font-size: 0.95rem;
    }

    .spinner {
        width: 44px;
        height: 44px;
        border-width: 4px;
    }

    #loadingText {
        font-size: 1.2rem;
    }
}

/* TABLET */
@media (min-width: 601px) and (max-width: 1024px) {

    #uiLabel {
        width: 60vw;
        font-size: 1.3rem;
    }

    #uiLabel h3 {
        font-size: 1.8rem;
    }

    .spinner {
        width: 54px;
        height: 54px;
    }
}

/* LARGE DESKTOP */
@media (min-width: 1600px) {

    #uiLabel {
        font-size: 1.6rem;
        padding: 30px;
    }

    #uiLabel h3 {
        font-size: 2.2rem;
    }

    .spinner {
        width: 82px;
        height: 82px;
    }

    #loadingText {
        font-size: 2rem;
    }
}
</style>
</head>
<body>

<div id="cesiumContainer"></div>

<div id="uiLabel">
    <div id="closeBtn">✕</div>
    <h3 id="labelHeader"></h3>
    <ul id="labelList"></ul>
</div>

<div id="loadingScreen">
  <div id="loaderContent">
    <div class="spinner"></div>
    <div id="loadingText">Ładowanie globusa...</div>
  </div>
</div>

<script>

if (typeof Cesium === "undefined") {
    document.body.innerHTML = "<h2 style='color:white;padding:20px'>Cesium failed to load.</h2>";
    throw new Error("Cesium is not defined");
}

Cesium.Ion.defaultAccessToken = null;

const isMobile = window.innerWidth < 600;
const starSize = isMobile ? 68 : 76;

const RAW_DATA = `
1|Zjednoczone Emiraty Arabskie|Dubai|55.2708|25.2048|marathon|01.02.2026
2|Egipt|Kair - Saqqara|31.2167|29.8717|half marathon|13.02.2026
3|USA|Little Rock Chalange|-92.2896|34.7465|10 km|28.02.2026
3|USA|Little Rock Chalange|-92.2896|34.7465|marathon|01.03.2026
4|USA|Los Angeles|-118.2437|34.0522|5 km|07.03.2026
4|USA|Los Angeles|-118.2437|34.0522|marathon|08.03.2026
5|Izrael|Jeruzalem|35.2137|31.7683|marathon|27.03.2026
6|Canada|Ottawa - Chalange|-75.6972|45.4215|2 km + 5 km + 10 km|23.05.2026
6|Canada|Ottawa - Chalange|-75.6972|45.4215|marathon|24.05.2026
6a|RPA|Cape Town|18.4241|-33.9249|10 km|23.05.2026
6a|RPA|Cape Town|18.4241|-33.9249|marathon|24.05.2026
7|USA|Alaska - Anchorage|-149.9003|61.2181|marathon|20.06.2026
8|Canada|Vancouver|-123.1207|49.2827|half marathon|28.06.2026
`;

let imageryReady = false;
let geoJsonReady = false;

const loadingText = document.getElementById('loadingText');

function hideLoadingScreen() {
    setTimeout(() => {
        loadingScreen.classList.add('hide');
        setTimeout(() => loadingScreen.style.display = 'none', 1000);
    }, 5000);
}

function checkLoading() {
    if (imageryReady && geoJsonReady) {
        hideLoadingScreen();
    }
}

function parseMarathons(text){
    const lines = text.split(/\r?\n/).filter(l=>l.trim());
    const map = new Map();
    lines.forEach(line=>{
        const [id,country,city,lonStr,latStr,type,date] = line.split("|");
        const lon=parseFloat(lonStr), lat=parseFloat(latStr);
        if(!map.has(id)){
            map.set(id,{id,country,city,lon,lat,marathons:[]});
        }
        map.get(id).marathons.push({type,date});
    });
    return Array.from(map.values());
}

const marathonPoints = parseMarathons(RAW_DATA);

const viewer = new Cesium.Viewer('cesiumContainer',{
    terrainProvider: new Cesium.EllipsoidTerrainProvider(),
    imageryProvider: new Cesium.SingleTileImageryProvider({
        url: 'https://upload.wikimedia.org/wikipedia/commons/2/2c/Blue_Marble_2002.png'
    }),
    baseLayerPicker:false,
    geocoder:false,
    homeButton:false,
    sceneModePicker:false,
    timeline:false,
    navigationHelpButton:false,
    animation:false,
    infoBox:false,
    selectionIndicator:false
});

viewer.imageryLayers.removeAll();

viewer.imageryLayers.addImageryProvider(
    new Cesium.SingleTileImageryProvider({
        url: 'https://eoimages.gsfc.nasa.gov/images/imagerecords/57000/57730/world.topo.bathy.200412.3x5400x2700.jpg',
        rectangle: Cesium.Rectangle.fromDegrees(-180, -90, 180, 90)
    })
);


function showLoadingText(newText) {
    const textEl = document.getElementById('loadingText');
    textEl.style.opacity = 0;
    setTimeout(() => {
        textEl.innerText = newText;
        textEl.style.opacity = 1;
    }, 350);
}

viewer.imageryLayers.addImageryProvider(
    new Cesium.UrlTemplateImageryProvider({
        url: 'https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png',
        subdomains: ['a','b','c'],
        minimumLevel: 0,
        maximumLevel: 19,
        alpha: 0.45,
        credit: '© OpenStreetMap contributors'
    })
);

viewer.scene.globe.tileLoadProgressEvent.addEventListener((count) => {
    if (count === 0 && !imageryReady) {
        imageryReady = true;
        showLoadingText('Malowanie krajów...');
        checkLoading();
    }
});

Cesium.GeoJsonDataSource.load('countries.geojson', {
    clampToGround: false
}).then(function(ds){
    viewer.dataSources.add(ds);
    ds.entities.values.forEach(e => {
        e.polygon.material = Cesium.Color.fromRandom({ alpha: 0.6 });
        e.polygon.outline = true;
        e.polygon.outlineColor = Cesium.Color.BLACK;
    });
    geoJsonReady = true;
    checkLoading();
});

viewer.scene.globe.enableLighting = true;
viewer.scene.skyAtmosphere.show = true;
viewer.scene.globe.atmosphereLightIntensity = 10.0;

const controller = viewer.scene.screenSpaceCameraController;
controller.enableTilt = false;
controller.enableLook = false;
controller.enableTranslate = false; // prevents panning off globe
viewer.cesiumWidget.screenSpaceEventHandler.removeInputAction(
    Cesium.ScreenSpaceEventType.LEFT_DOUBLE_CLICK
);

function createStarDataURL(){
    const canvas=document.createElement('canvas');
    canvas.width=128;
    canvas.height=128;
    const ctx=canvas.getContext('2d');

    ctx.translate(64,64);
    ctx.beginPath();
    for(let i=0;i<5;i++){
        ctx.lineTo(0,-40);
        ctx.rotate(Math.PI/5);
        ctx.lineTo(0,-18);
        ctx.rotate(Math.PI/5);
    }
    ctx.closePath();
    ctx.fillStyle='#FFD700';
    ctx.shadowColor='#FFA000';
    ctx.shadowBlur=30;
    ctx.fill();

    return canvas.toDataURL();
}

const starImage = createStarDataURL();

marathonPoints.forEach(p=>{
    const entity = viewer.entities.add({
        position: Cesium.Cartesian3.fromDegrees(p.lon,p.lat,150000),
        billboard:{
            image: starImage,
            width:starSize,
            height:starSize,
            scaleByDistance: new Cesium.NearFarScalar(1000000,1.5,20000000,0.8)
        },
    });
    entity.data=p;
});

const label = document.getElementById('uiLabel');
const closeBtn = document.getElementById('closeBtn');
let activeEntity=null;

const handler=new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
handler.setInputAction(function(click){
    const picked=viewer.scene.pick(click.position);
    if(Cesium.defined(picked)&&picked.id){
        activeEntity=picked.id;
        updatePopup();
    } else {
        label.classList.remove('show');
        activeEntity=null;
    }
},Cesium.ScreenSpaceEventType.LEFT_CLICK);

function updatePopup() {
    if (!activeEntity || !activeEntity.data) return;
    const p = activeEntity.data;

    if (label.classList.contains('show')) {
        label.classList.remove('show');
        label.addEventListener('transitionend', function handler() {
            label.removeEventListener('transitionend', handler);
            showPopupContent(p);
        });
    } else {
        showPopupContent(p);
    }
}

function showPopupContent(p) {
    document.getElementById('labelHeader').innerText = `${p.country} — ${p.city}`;
    const list = document.getElementById('labelList');
    list.innerHTML = '';
    p.marathons.forEach(m => {
        const li = document.createElement('li');
        li.innerHTML = `<b>${m.type}</b>: ${m.date}`;
        list.appendChild(li);
    });
    label.classList.add('show');
}

closeBtn.addEventListener('click', ()=>{
    label.classList.remove('show');
    activeEntity = null;
});

viewer.camera.setView({
    destination: Cesium.Cartesian3.fromDegrees(20,20,10000000)
});
viewer.scene.screenSpaceCameraController.minimumZoomDistance = 5000000;
viewer.scene.screenSpaceCameraController.maximumZoomDistance = 7000000*3.14;


label.classList.remove('show');

</script>
</body>
</html>
