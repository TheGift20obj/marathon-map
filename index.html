<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8">
<title>CesiumJS - FlyTo poprawiony</title>
<script src="https://unpkg.com/cesium/Build/Cesium/Cesium.js"></script>
<link href="https://unpkg.com/cesium/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
<style>
  html, body, #cesiumContainer { width:100%; height:100%; margin:0; padding:0; }
  #uiLabel {
    position:absolute;
    background:white;
    border:1px solid #333;
    padding:5px;
    display:none;
    pointer-events:none;
  }
</style>
</head>
<body>
<div id="cesiumContainer"></div>
<div id="uiLabel">
  <span id="labelText"></span>
  <button id="closeBtn" style="margin-left:5px;">X</button>
</div>

<script>
const viewer = new Cesium.Viewer('cesiumContainer', {
    baseLayerPicker: false,
    geocoder: false,
    homeButton: false,
    sceneModePicker: false,
    timeline: false,
    navigationHelpButton: false,
    animation: false,
    creditsDisplay: false,    // usuwa box w górnym rogu
    selectionIndicator: false, // usuwa zielone ramki wokół punktów
    infoBox: false,             // wyłącza cały infoBox
    terrainProvider: new Cesium.EllipsoidTerrainProvider()
});

// OSM
viewer.imageryLayers.addImageryProvider(
    new Cesium.OpenStreetMapImageryProvider({ url: 'https://a.tile.openstreetmap.org/' })
);

// Wyłączenie kosmosu
const scene = viewer.scene;
scene.skyBox.show = false;
scene.skyAtmosphere.show = false;
scene.sun.show = false;
scene.moon.show = false;

// Kamera startowa
viewer.camera.setView({ destination: Cesium.Cartesian3.fromDegrees(0,0,2000000) });
scene.screenSpaceCameraController.minimumZoomDistance = 5000;
scene.screenSpaceCameraController.maximumZoomDistance = 6371000*2;
// Punkty
const marathonPoints = [
  { name: "Dubai Marathon", lon: 55.2708, lat: 25.2048, date: "01.02.2026" },
  { name: "Saqqara Half Marathon", lon: 31.2167, lat: 29.8717, date: "13.02.2026" },
  { name: "Little Rock 10 km", lon: -92.2896, lat: 34.7465, date: "28.02.2026" },
  { name: "Little Rock Marathon", lon: -92.2896, lat: 34.7465, date: "01.03.2026" },
  { name: "Los Angeles 5 km", lon: -118.2437, lat: 34.0522, date: "07.03.2026" },
  { name: "Los Angeles Marathon", lon: -118.2437, lat: 34.0522, date: "08.03.2026" },
  { name: "Jerusalem Marathon", lon: 35.2137, lat: 31.7683, date: "27.03.2026" },
  { name: "Ottawa 2km+5km+10km", lon: -75.6972, lat: 45.4215, date: "23.05.2026" },
  { name: "Ottawa Marathon", lon: -75.6972, lat: 45.4215, date: "24.05.2026" },
  { name: "Cape Town 10 km", lon: 18.4241, lat: -33.9249, date: "23.05.2026" },
  { name: "Cape Town Marathon", lon: 18.4241, lat: -33.9249, date: "24.05.2026" },
  { name: "Anchorage Marathon", lon: -149.9003, lat: 61.2181, date: "20.06.2026" },
  { name: "Vancouver Half Marathon", lon: -123.1207, lat: 49.2827, date: "28.06.2026" }
];

// Dodanie entity i stanu kliknięcia
const points = marathonPoints.map(p => {
    const entity = viewer.entities.add({
        position: Cesium.Cartesian3.fromDegrees(p.lon, p.lat, 0),
        point: {
            pixelSize: 10,
            color: Cesium.Color.RED,
            outlineColor: Cesium.Color.WHITE,
            outlineWidth: 1
        },
        description: `${p.name} <br> ${p.date}` // opcjonalnie, jeśli chcesz standardowe Cesium overlay
    });

    // Dodatkowe dane i stan kliknięcia
    entity.data = p;
    entity.clickState = 0; // 0 = brak kliknięcia, 1 = 1 klik

    return entity;
});

const label = document.getElementById('uiLabel');
const labelText = document.getElementById('labelText');
const closeBtn = document.getElementById('closeBtn');

let activeEntity = null;

// Funkcja ukrywania overlay
function hideOverlay() {
    activeEntity = null;
    label.style.display = 'none';
}

// Przycisk zamykania
closeBtn.addEventListener('click', hideOverlay);

// Klik handler dla punktów
const handler = new Cesium.ScreenSpaceEventHandler(scene.canvas);
handler.setInputAction(function(click){
    const picked = scene.pick(click.position);
    if(Cesium.defined(picked) && picked.id){
        const entity = picked.id;

        if(entity.clickState === 0){
            // 1 klik → overlay
            entity.clickState = 1;
            activeEntity = entity;
            points.forEach(p => { if(p!==entity) p.clickState = 0; });

        } else {
            // 2 klik → flyTo
            viewer.camera.flyTo({
                destination: Cesium.Cartesian3.fromDegrees(
                    entity.data.lon,
                    entity.data.lat,
                    50000
                ),
                duration: 1.5
            });
            entity.clickState = 0;
            activeEntity = entity;
        }

    } else {
        // Klik poza punktami → ukryj overlay
        hideOverlay();
        // reset clickState wszystkich punktów
        points.forEach(p => p.clickState = 0);
    }
}, Cesium.ScreenSpaceEventType.LEFT_CLICK);

// Aktualizacja overlay w preRender
viewer.scene.preRender.addEventListener(()=>{
    if(activeEntity){
        const pos = activeEntity.position.getValue(Cesium.JulianDate.now());
        const windowPos = scene.cartesianToCanvasCoordinates(pos);
        if(windowPos){
            labelText.innerHTML = `<b>${activeEntity.data.name}</b>`;
            label.style.left = windowPos.x + 'px';
            label.style.top = windowPos.y + 'px';
            label.style.display = 'block';
        }
    }
});
viewer.scene.screenSpaceCameraController.enableRotate = true;
viewer.scene.screenSpaceCameraController.enableTranslate = true;
viewer.scene.screenSpaceCameraController.enableTilt = true;
viewer.scene.screenSpaceCameraController.enableZoom = true;

// **To najważniejsze:**
viewer.scene.screenSpaceCameraController.enableLook = false; 
// lub dokładniej: zablokuj domyślny double-click zoom
viewer.scene.screenSpaceCameraController.enableInputs = true;
viewer.scene.screenSpaceCameraController.enableDoubleClickZoom = false;

viewer.cesiumWidget.screenSpaceEventHandler.removeInputAction(
    Cesium.ScreenSpaceEventType.LEFT_DOUBLE_CLICK
);

</script>
</body>
</html>
