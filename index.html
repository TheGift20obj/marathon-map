<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8">
<title>CesiumJS - FlyTo poprawiony</title>
<script src="https://unpkg.com/cesium/Build/Cesium/Cesium.js"></script>
<link href="https://unpkg.com/cesium/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
<style>
html, body, #cesiumContainer { width:100%; height:100%; margin:0; padding:0; }
#uiLabel {
  position: absolute;
  background: rgba(255, 255, 255, 0.95);
  border: 2px solid #4CAF50;   
  border-radius: 8px;
  padding: 8px 12px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.3);
  display: none;
  pointer-events: auto;
  min-width: 200px;
  font-family: Arial, sans-serif;
  font-size: 14px;
  z-index: 1000;
}

/* mobile responsive */
@media (max-width: 768px) {
  #uiLabel {
    min-width: 300px;
    font-size: 18px;
    padding: 16px 20px;
  }
  #closeBtn {
    font-size: 16px;
    padding: 4px 8px;
  }
}

/* Wrapper nagłówek + button */
#labelHeaderWrapper {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 6px;
}

/* Nagłówek zajmuje pozostałą przestrzeń */
#labelHeader {
  font-weight: bold;
  flex-grow: 1;
}

/* Przycisk */
#closeBtn {
  flex-shrink: 0;
  cursor: pointer;
  background: #4CAF50;
  color: white;
  border: none;
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 12px;
}

#closeBtn:hover {
  background: #45a049;
}

#uiLabel ul li {
  margin-bottom: 4px;
}
</style>
</head>
<body>
<div id="cesiumContainer"></div>
<div id="uiLabel">
  <div id="labelHeaderWrapper">
    <div id="labelHeader"></div>
    <button id="closeBtn">X</button>
  </div>
  <ul id="labelList" style="margin:0; padding:0; list-style:none;"></ul>
</div>
<script>
function loadMarathonsFromURL(url, callback) {
    fetch(url)
        .then(response => {
            if (!response.ok) throw new Error("Nie udało się wczytać pliku");
            return response.text();
        })
        .then(text => {
            const lines = text.split(/\r?\n/).filter(line => line.trim() !== "");
            const marathonMap = new Map();

            lines.forEach(line => {
                const parts = line.split("|").map(p => p.trim());
                if(parts.length < 7) return;

                const [id, country, city, lonStr, latStr, type, date] = parts;
                const lon = parseFloat(lonStr);
                const lat = parseFloat(latStr);

                // jeśli obiekt o tym id nie istnieje, dodajemy
                if (!marathonMap.has(id)) {
                    marathonMap.set(id, {
                        id: id,
                        country: country,
                        city: city,
                        lon: lon,
                        lat: lat,
                        marathons: []
                    });
                }

                // dodajemy maraton do tablicy marathons
                marathonMap.get(id).marathons.push({ type: type, date: date });
            });

            // zamiana mapy na tablicę
            const marathonPointsGrouped = Array.from(marathonMap.values());
            callback(marathonPointsGrouped);
        })
        .catch(err => console.error("Błąd wczytywania maratonów:", err));
}

const viewer = new Cesium.Viewer('cesiumContainer', {
    terrainProvider: new Cesium.EllipsoidTerrainProvider(),

    imageryProvider: new Cesium.OpenStreetMapImageryProvider({
        url: "https://a.tile.openstreetmap.org/"
    }),
    baseLayerPicker: false,
    geocoder: false,
    homeButton: false,
    sceneModePicker: false,
    timeline: false,
    navigationHelpButton: false,
    animation: false,
    creditsDisplay: false,    // usuwa box w górnym rogu
    selectionIndicator: false, // usuwa zielone ramki wokół punktów
    infoBox: false,
});

const controller = viewer.scene.screenSpaceCameraController;
controller.enableTranslate = false;
controller.enableRotate = false;
controller.enableTilt = false;
controller.enableLook = false;
controller.enableZoom = true;
controller.enableDoubleClickZoom = false;

// Wyłącz multi-touch dla mobilnych
controller.rotateEventTypes = [];
controller.tiltEventTypes = [];
controller.translateEventTypes = [];
controller.pinchEventTypes = [];
controller.wheelEventTypes = [];

// odłączenie double-click zoom
controller.enableDoubleClickZoom = false;
viewer.cesiumWidget.screenSpaceEventHandler.removeInputAction(
    Cesium.ScreenSpaceEventType.LEFT_DOUBLE_CLICK
);
viewer.cesiumWidget.screenSpaceEventHandler.removeInputAction(
    Cesium.ScreenSpaceEventType.PINCH_MOVE
);

// OSM
viewer.imageryLayers.addImageryProvider(
    new Cesium.OpenStreetMapImageryProvider({ url: 'https://a.tile.openstreetmap.org/' })
);

// Wyłączenie kosmosu
const scene = viewer.scene;
scene.skyBox.show = false;
scene.skyAtmosphere.show = false;
scene.sun.show = false;
scene.moon.show = false;

const ellipsoid = Cesium.Ellipsoid.WGS84;
const occluder = new Cesium.EllipsoidalOccluder(
    ellipsoid,
    viewer.camera.positionWC
);

// Kamera startowa
viewer.camera.setView({ destination: Cesium.Cartesian3.fromDegrees(0,0,2000000) });
scene.screenSpaceCameraController.minimumZoomDistance = 5000;
scene.screenSpaceCameraController.maximumZoomDistance = 6371000*2;
// Punkty

const label = document.getElementById('uiLabel');
const labelText = document.getElementById('labelText');
const closeBtn = document.getElementById('closeBtn');

let activeEntity = null;

// Funkcja ukrywania overlay
function hideOverlay() {
    activeEntity = null;
    label.style.display = 'none';
}

// Przycisk zamykania
closeBtn.addEventListener('click', hideOverlay);

loadMarathonsFromURL("marathons.txt", function(marathonPoints){

    const points = marathonPoints.map(p => {
        const entity = viewer.entities.add({
            position: Cesium.Cartesian3.fromDegrees(p.lon, p.lat, 1),
            billboard: {
                image: "star.png",
                width: 28,
                height: 28,
                verticalOrigin: Cesium.VerticalOrigin.BOTTOM
            }
        });
        entity.data = p;
        entity.clickState = 0;
        return entity;
    });

    // ---------------------- Handler kliknięcia ----------------------
    const handler = new Cesium.ScreenSpaceEventHandler(scene.canvas);
    handler.setInputAction(function(click){
        const picked = scene.pick(click.position);
        if(Cesium.defined(picked) && picked.id){
            const entity = picked.id;

            if(entity.clickState === 0){
                entity.clickState = 1;
                activeEntity = entity;
                points.forEach(p => { if(p!==entity) p.clickState = 0; });

            } else {
                viewer.camera.flyTo({
                    destination: Cesium.Cartesian3.fromDegrees(
                        entity.data.lon,
                        entity.data.lat,
                        50000
                    ),
                    duration: 1.5
                });
                entity.clickState = 0;
                activeEntity = entity;
            }

        } else {
            hideOverlay();
            points.forEach(p => p.clickState = 0);
        }
    }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

    // ---------------------- Aktualizacja overlay i widoczności billboardów ----------------------
    viewer.scene.preRender.addEventListener(() => {
        if (activeEntity) {
            const pos = activeEntity.position.getValue(Cesium.JulianDate.now());
            const windowPos = scene.cartesianToCanvasCoordinates(pos);
            if (windowPos) {

                // nagłówek: country + city
                const labelHeader = document.getElementById('labelHeader');
                labelHeader.innerHTML = `${activeEntity.data.country}: ${activeEntity.data.city}`;

                // lista maratonów
                const labelList = document.getElementById('labelList');
                labelList.innerHTML = "";
                activeEntity.data.marathons.forEach(m => {
                    const li = document.createElement("li");
                    li.innerHTML = `<b>${m.type}</b>: ${m.date}`;
                    labelList.appendChild(li);
                });

                // ustawienie pozycji overlay
                label.style.left = windowPos.x + 'px';
                label.style.top = windowPos.y + 'px';
                label.style.display = 'block';
            }
        } else {
            label.style.display = 'none';
        }

        // occluder dla billboardów
        occluder.cameraPosition = viewer.camera.positionWC;
        points.forEach(entity => {
            const pos = entity.position.getValue(Cesium.JulianDate.now());
            entity.billboard.show = occluder.isPointVisible(pos);
        });
    });

});

</script>
</body>
</html>
