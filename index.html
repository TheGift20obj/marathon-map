<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Cesium Marathon Globe</title>

<script src="https://unpkg.com/cesium@1.111.0/Build/Cesium/Cesium.js"></script>
<link href="https://unpkg.com/cesium@1.111.0/Build/Cesium/Widgets/widgets.css" rel="stylesheet">

<style>
html, body, #cesiumContainer {
    width:100%; height:100%; margin:0; padding:0;
    overflow:hidden; background:#000814;
}
#cesiumContainer { position:relative; }

#uiLabel {
    position: absolute;
    top: 70%;  /* 70% od góry parenta */
    left: 50%;
    transform: translate(-50%, 100%); /* start poza ekranem w dół */
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
    font-family: system-ui;
    font-size: 1.5em;
    padding: 20px;

    background: linear-gradient(135deg, #6fb1fc, #4364f7);
    color: #fff;
    border-radius: 20px;
    border: 2px solid #ffffff55;
    box-shadow: 0 12px 30px rgba(0,0,0,0.6);

    opacity: 0;
    pointer-events: none;
    transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55), opacity 0.4s ease-in-out;
    z-index: 50;
}

#uiLabel.show {
    transform: translate(-50%, 0);  /* element zjeżdża w górę do widocznej pozycji */
    opacity: 1;
    pointer-events: auto;
}

#uiLabel h3 {
    margin:0 0 8px 0;
    font-size:32px;
    color: #fff;   /* jasny, kontrastowy nagłówek */
}

#uiLabel ul {
    padding-left: 0;
    margin: 10px 0 0 0;
    list-style: none;
}

#uiLabel ul li {
    margin: 4px 0;
    font-weight: 500;
    color: #f0f0f0;
}

#closeBtn {
    position: absolute;
    top: 8px;
    right: 12px;
    cursor: pointer;
    font-weight: bold;
    font-size: 1.2em;
    color: #fff;
    transition: color 0.3s ease;
}

#closeBtn:hover {
    color: #ffdd57;  /* delikatny efekt hover */
}

/* responsywność (opcjonalnie) */
@media (max-width: 480px) {
    #uiLabel {
        width: 85vw;
        font-size: 1.2em;
        padding: 16px;
    }
    #uiLabel h3 {
        font-size: 24px;
    }
}

/* Nowy styl loading screen */
#loadingScreen {
    position: fixed;
    top:0; left:0;
    width:100%; height:100%;
    background: linear-gradient(135deg,#6fb1fc,#4364f7);
    color: white;
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    opacity: 1;
    transition: opacity 1s ease-in-out;
    flex-direction: column;
    font-family: system-ui;
}

#loaderContent {
    text-align: center;
}

.spinner {
    width: 60px;
    height: 60px;
    border: 6px solid #ffffff44;
    border-top: 6px solid #fff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 20px;
}

@keyframes spin {
    from {transform: rotate(0deg);}
    to {transform: rotate(360deg);}
}

#loadingText {
    font-size: 1.5em;
    margin-top: 0.5em;
    transition: opacity 0.8s ease;
}

#loadingScreen.hide {
    opacity: 0;
    pointer-events: none;
}
</style>
</head>
<body>

<div id="cesiumContainer"></div>

<div id="uiLabel">
    <div id="closeBtn">✕</div>
    <h3 id="labelHeader"></h3>
    <ul id="labelList"></ul>
</div>

<!-- DODAJ PRZED CESIUM CONTAINER -->
<div id="loadingScreen">
  <div id="loaderContent">
    <div class="spinner"></div>
    <div id="loadingText">Ładowanie globusa...</div>
  </div>
</div>

<script>

if (typeof Cesium === "undefined") {
    document.body.innerHTML = "<h2 style='color:white;padding:20px'>Cesium failed to load.</h2>";
    throw new Error("Cesium is not defined");
}

Cesium.Ion.defaultAccessToken = null;

// ---------- DATA ----------
const RAW_DATA = `
1|Zjednoczone Emiraty Arabskie|Dubai|55.2708|25.2048|marathon|01.02.2026
2|Egipt|Kair - Saqqara|31.2167|29.8717|half marathon|13.02.2026
3|USA|Little Rock Chalange|-92.2896|34.7465|10 km|28.02.2026
3|USA|Little Rock Chalange|-92.2896|34.7465|marathon|01.03.2026
4|USA|Los Angeles|-118.2437|34.0522|5 km|07.03.2026
4|USA|Los Angeles|-118.2437|34.0522|marathon|08.03.2026
5|Izrael|Jeruzalem|35.2137|31.7683|marathon|27.03.2026
6|Canada|Ottawa - Chalange|-75.6972|45.4215|2 km + 5 km + 10 km|23.05.2026
6|Canada|Ottawa - Chalange|-75.6972|45.4215|marathon|24.05.2026
6a|RPA|Cape Town|18.4241|-33.9249|10 km|23.05.2026
6a|RPA|Cape Town|18.4241|-33.9249|marathon|24.05.2026
7|USA|Alaska - Anchorage|-149.9003|61.2181|marathon|20.06.2026
8|Canada|Vancouver|-123.1207|49.2827|half marathon|28.06.2026
`;

let imageryReady = false;
let geoJsonReady = false;

const loadingText = document.getElementById('loadingText');

function hideLoadingScreen() {
    // czekamy jeszcze 5 sekund dla efektu
    setTimeout(() => {
        loadingScreen.classList.add('hide');
        setTimeout(() => loadingScreen.style.display = 'none', 1000);
    }, 5000);
}

function checkLoading() {
    if (imageryReady && geoJsonReady) {
        hideLoadingScreen();
    }
}

function parseMarathons(text){
    const lines = text.split(/\r?\n/).filter(l=>l.trim());
    const map = new Map();
    lines.forEach(line=>{
        const [id,country,city,lonStr,latStr,type,date] = line.split("|");
        const lon=parseFloat(lonStr), lat=parseFloat(latStr);
        if(!map.has(id)){
            map.set(id,{id,country,city,lon,lat,marathons:[]});
        }
        map.get(id).marathons.push({type,date});
    });
    return Array.from(map.values());
}

const marathonPoints = parseMarathons(RAW_DATA);

// ---------- VIEWER WITH STATIC EARTH TEXTURE (NO AUTH, NO TILES) ----------
const viewer = new Cesium.Viewer('cesiumContainer',{
    terrainProvider: new Cesium.EllipsoidTerrainProvider(),
    imageryProvider: new Cesium.SingleTileImageryProvider({
        // NASA Blue Marble style – natural globe colors
        url: 'https://upload.wikimedia.org/wikipedia/commons/2/2c/Blue_Marble_2002.png'
    }),
    baseLayerPicker:false,
    geocoder:false,
    homeButton:false,
    sceneModePicker:false,
    timeline:false,
    navigationHelpButton:false,
    animation:false,
    infoBox:false,
    selectionIndicator:false
});

viewer.imageryLayers.removeAll();

viewer.imageryLayers.addImageryProvider(
    new Cesium.SingleTileImageryProvider({
        url: 'https://eoimages.gsfc.nasa.gov/images/imagerecords/57000/57730/world.topo.bathy.200412.3x5400x2700.jpg',
        rectangle: Cesium.Rectangle.fromDegrees(-180, -90, 180, 90)
    })
);


function showLoadingText(newText) {
    const textEl = document.getElementById('loadingText');
    // Fade out
    textEl.style.opacity = 0;
    setTimeout(() => {
        textEl.innerText = newText;
        // Fade in
        textEl.style.opacity = 1;
    }, 350); // czas dopasowany do transition CSS
}


// OPTIONAL:
// półprzezroczysta nakładka OSM z etykietami:
viewer.imageryLayers.addImageryProvider(
    new Cesium.UrlTemplateImageryProvider({
        url: 'https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png',
        subdomains: ['a','b','c'],
        minimumLevel: 0,
        maximumLevel: 19,
        alpha: 0.45, // półprzezroczystość
        credit: '© OpenStreetMap contributors'
    })
);

viewer.scene.globe.tileLoadProgressEvent.addEventListener((count) => {
    // count = liczba aktualnie ładowanych tiles
    if (count === 0 && !imageryReady) {
        imageryReady = true;
        showLoadingText('Malowanie krajów...');
        checkLoading();
    }
});

Cesium.GeoJsonDataSource.load('countries.geojson', {
    clampToGround: false
}).then(function(ds){
    viewer.dataSources.add(ds);
    ds.entities.values.forEach(e => {
        e.polygon.material = Cesium.Color.fromRandom({ alpha: 0.6 });
        e.polygon.outline = true;
        e.polygon.outlineColor = Cesium.Color.BLACK;
    });
    geoJsonReady = true;
    checkLoading();
});

viewer.scene.globe.enableLighting = true;
viewer.scene.skyAtmosphere.show = true;
viewer.scene.globe.atmosphereLightIntensity = 10.0;

// ---------- LIMIT CAMERA CONTROLS (ONLY ZOOM + ROTATE) ----------
const controller = viewer.scene.screenSpaceCameraController;
controller.enableTilt = false;
controller.enableLook = false;
controller.enableTranslate = false; // prevents panning off globe
viewer.cesiumWidget.screenSpaceEventHandler.removeInputAction(
    Cesium.ScreenSpaceEventType.LEFT_DOUBLE_CLICK
);

// ---------- STAR ICON (BIGGER + GLOW) ----------
function createStarDataURL(){
    const canvas=document.createElement('canvas');
    canvas.width=128;
    canvas.height=128;
    const ctx=canvas.getContext('2d');

    ctx.translate(64,64);
    ctx.beginPath();
    for(let i=0;i<5;i++){
        ctx.lineTo(0,-40);
        ctx.rotate(Math.PI/5);
        ctx.lineTo(0,-18);
        ctx.rotate(Math.PI/5);
    }
    ctx.closePath();
    ctx.fillStyle='#FFD700';
    ctx.shadowColor='#FFA000';
    ctx.shadowBlur=30;
    ctx.fill();

    return canvas.toDataURL();
}

const starImage = createStarDataURL();

// ---------- ADD MARKERS ----------
marathonPoints.forEach(p=>{
    const entity = viewer.entities.add({
        position: Cesium.Cartesian3.fromDegrees(p.lon,p.lat,150000),
        billboard:{
            image: starImage,
            width:64,
            height:64,
            //verticalOrigin:Cesium.VerticalOrigin.TOP,
            scaleByDistance: new Cesium.NearFarScalar(1000000,1.5,20000000,0.8)
        },
    });
    entity.data=p;
});

// ---------- POPUP ----------
const label = document.getElementById('uiLabel');
const closeBtn = document.getElementById('closeBtn');
let activeEntity=null;

const handler=new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
handler.setInputAction(function(click){
    const picked=viewer.scene.pick(click.position);
    if(Cesium.defined(picked)&&picked.id){
        activeEntity=picked.id;
        updatePopup();
    } else {
        //label.style.display='none';
        label.classList.remove('show');
        activeEntity=null;
    }
},Cesium.ScreenSpaceEventType.LEFT_CLICK);

function updatePopup() {
    if (!activeEntity || !activeEntity.data) return;
    const p = activeEntity.data;

    // jeśli popup jest już pokazany
    if (label.classList.contains('show')) {
        // najpierw animacja znikania
        label.classList.remove('show');

        // po zakończeniu animacji chowającej, aktualizujemy treść i wjeżdżamy
        label.addEventListener('transitionend', function handler() {
            label.removeEventListener('transitionend', handler);
            showPopupContent(p);
        });
    } else {
        showPopupContent(p);
    }
}

function showPopupContent(p) {
    document.getElementById('labelHeader').innerText = `${p.country} — ${p.city}`;
    const list = document.getElementById('labelList');
    list.innerHTML = '';
    p.marathons.forEach(m => {
        const li = document.createElement('li');
        li.innerHTML = `<b>${m.type}</b>: ${m.date}`;
        list.appendChild(li);
    });
    label.classList.add('show');
}

closeBtn.addEventListener('click', ()=>{
    // Usuwamy klasę show, animacja powrotu w dół
    label.classList.remove('show');
    activeEntity = null;
});

viewer.camera.setView({
    destination: Cesium.Cartesian3.fromDegrees(20,20,10000000)
});
viewer.scene.screenSpaceCameraController.minimumZoomDistance = 5000000;
viewer.scene.screenSpaceCameraController.maximumZoomDistance = 7000000*3.14;


label.classList.remove('show');

</script>
</body>
</html>
